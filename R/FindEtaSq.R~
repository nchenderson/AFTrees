dinvchisq <- function(x, nu) {
    ans <- (nu/2)*log(nu/2) - lgamma(nu/2) - (nu/2 + 1)*log(x) - nu/(2*x)
    return(exp(ans))
}

pchiconv <- function(p, nu) {
    ### CDF for the random variable defined as
    ###  nu/X + Z  where X is chi_sq with nu degrees of freedom and Z ~ N(1,1) 
    ff <- function(v,x) {
         ans <- pnorm(x - v, mean=1,sd=1)*dinvchisq(v, nu=nu)
         return(ans)
    }
    tau <- length(p)
    a <- rep(0, tau)
    for(k in 1:tau) {
        a[k] <- integrate(ff, x=p[k], lower=0, upper=Inf)$value
    }
    return(a)
}

qchiconv <- function(q, nu) {
    gg <- function(x) {
         pchiconv(x, nu=nu) - q
    }
    a <- uniroot(gg, interval=c(0,200))
    return(a$root)
}

FindEtaSq <- function(q, sigsq.hat, nu) {
    Q <- qchiconv(q, nu=nu)
    eta.sq <- sigsq.hat/Q
    return(eta.sq)
}
