{
    "collab_server" : "",
    "contents" : "\n\nlibrary(AFTrees)\nlibrary(numDeriv)\n\n#load(\"~/personalized/Data/solvd.RData\")\nsource(file=\"~/personalized/aft_code/HistogramEstimate.R\")\n\n\n\n\ndata(solvd_pt)\n\n\nform <- ttodthorchfhosp ~ study + age + smoke + diabet + lvef + himi + nyha + depedema + crackles + weightkg + anydiurbl + avsys + avdia + beat + creatinine + sodium + copd + histk + gender - 1\nXX <- model.matrix(form, solvd)\nstatus <- solvd$deathorchfhosp\nyy <- solvd$ttodthorchfhosp\nTrts <- as.numeric(solvd$trt == \"treatment\")\n\n\n\nsystem.time(obj <- IndivAFT(x.train=XX,y.train=yy,status=status,Trt=Trts, ndpost=1000,nskip=1000,printevery=100))\n## about 170 samples per minute\n\n\n\n\n\nmuhat <- colMeans(obj$yhat.train)\n\nftrt <- supsmu(solvd$lvef[Trts==1], muhat[Trts==1])\nfno <- supsmu(solvd$lvef[Trts==0], muhat[Trts==0])\n### The registry data seems to have no treatment effect\n#postscript(file=\"~/Presentations/ENAR16/Figures/lvef.eps\", width=6.5, height=4.5, horizontal=FALSE)\npar(mfrow=c(1,1), mar=c(4.1, 4.1, .5, .5))\nplot(solvd$lvef, muhat, type=\"n\", ylim=c(4,8.6), las=1, xlab=\"baseline ejection fraction\",\n     ylab=\"log survival time\")\npoints(solvd$lvef[Trts==1], muhat[Trts==1], col=\"red\", pch=16, cex=.6)\npoints(solvd$lvef[Trts==0], muhat[Trts==0], pch=16, cex=.6)\nlines(ftrt$x, ftrt$y, col=\"red\", lwd=2)\nlines(fno$x, fno$y, lwd=2)\nlegend(\"bottomright\", legend=c(\"Enalapril\", \"Placebo\"), bty=\"n\", pch=16, col=c(\"red\",\"black\"))\n#dev.off()\n\n\n\n\n########################################################################\n#######  Histogram Estimate  (for difference in log-survival)\n###########################################################################\n\npmeans <- colMeans(obj$Theta)\n### do a regression here.\n\ntgrid=seq(-.4,1.7,length.out=500)\n\n\nind_trt <- solvd$study == \"SOLVD Treatment\"\nind_prev <- solvd$study == \"SOLVD Prevention\"\n\nhist_est_trt <- HistogramEstimate(obj$Theta[,ind_trt], tgrid=tgrid)\nhist_est_prev <- HistogramEstimate(obj$Theta[,ind_prev], tgrid=tgrid)\n\n\nind <- c(1:10, 490:500)\ntgrid_new <- tgrid[-ind]\nraw_deriv_trt <- grad(hist_est_trt$Postedf, x=tgrid_new)\nraw_deriv_prev <- grad(hist_est_prev$Postedf, x=tgrid_new)\n\n### 98 % estimate\nsdens_trt <- supsmu(tgrid_new, raw_deriv_trt)\nsdens_prev <- supsmu(tgrid_new, raw_deriv_prev)\n\n#postscript(file=\"~/Presentations/ENAR16/Figures/histogram_est.eps\", width=6.5, height=4.5, horizontal=FALSE)\npar(mfrow=c(1,1), mar=c(4.1, 4.1, 1, .25))\nhist(pmeans, breaks=30, prob=TRUE, xlim=c(-.4,1.4), las=1, xlab=\"treatment effect (difference in mean log-surival)\", ylab=\"Density\",\n     main=\"\", cex.axis=.8, xaxt='n')\naxis(1, at=c(-.25,0,.25,.5,.75,1,1.25,1.5), cex.axis=.8)\n#axis(2, at=c(1,2,3,4,5,6), cex=.8, las=1)\nlines(sdens_trt$x, sdens_trt$y, lwd=2)\nlines(sdens_prev$x, sdens_prev$y, lwd=2, col=\"red\")\nabline(v=0, lwd=3, lty=2)\ntext(1.0,4.5,labels=\"Mean log-survival time = 7.08\", cex=.9)\ntext(1.02,4.1,labels=\"Average Treatment Effect = 0.56\", cex=.9)\ntext(1.02,3.7,labels=\"Est. Proportion who benefit = 0.98\", cex=.9)\n#dev.off()\n\n\n\n#################################################################################################\n###   Run model for time differences\n#############################################################################################\n\nnskip <- 500*5\nndpost <- 1000*5\n#nskip <- 100\n#ndpost <- 100\nsystem.time(obj <- IndivAFT(x.train=XX,y.train=yy,status=status,Trt=Trts, sigquant=.5,ndpost=ndpost,nskip=nskip,printevery=100, keepevery=5,\n                            scale=\"time\"))\n## about 30 minutes\nsystem.time(obj_log <- IndivAFT(x.train=XX,y.train=yy,status=status,Trt=Trts, sigquant=.5, ndpost=ndpost,nskip=nskip,printevery=100, keepevery=5))\n\n\n#save(obj, file=\"~/personalized/Data/solvd_fit.RData\")\n#save(obj_log, file=\"~/personalized/Data/solvd_fit_log.RData\")\n\n################################################################################################\n####\n\n### Also need to compute posterior of variation.\npmeans <- colMeans(obj$Theta)\nhist(pmeans)\n##sum(pmeans < 1)/6249  ### about 2.5% of subjects have posterior means less than one  (most of these come from the Prev trial)\n\nt0 <- 0\nt1 <- 4\ntgrid=seq(t0,t1,length.out=500)\n\n\nind_trt <- solvd$study == \"SOLVD Treatment\"\nind_prev <- solvd$study == \"SOLVD Prevention\"\n\nsum(pmeans[ind_trt] < 1)/sum(ind_trt)\nsum(pmeans[ind_prev] < 1)/sum(ind_prev)\n\nhist_est_trt <- HistogramEstimate(obj$Theta[,ind_trt], tgrid=tgrid)\nhist_est_prev <- HistogramEstimate(obj$Theta[,ind_prev], tgrid=tgrid)\n\n\n#plot(hist_est_trt$dens, xlim=c(-.5,2), type=\"n\")\n#lines(hist_est_trt$tgrid, hist_est_trt$dens_grid, col=\"red\")\n\n\nind <- c(1:10, 490:500)\ntgrid_new <- tgrid[-ind]\nraw_deriv_trt <- grad(hist_est_trt$Postedf, x=tgrid_new)\nraw_deriv_prev <- grad(hist_est_prev$Postedf, x=tgrid_new)\n\n### 98 % estimate\nsdens_trt <- supsmu(tgrid_new, raw_deriv_trt)\nsdens_prev <- supsmu(tgrid_new, raw_deriv_prev)\n\nxl <- c(.27,3.5)\n## also try width 6.5, height=5\npostscript(file=\"~/workingpapers/AFTpersonal/Figures/histogram_est.eps\", width=6, height=5, horizontal=FALSE)\npar(mfrow=c(1,1), mar=c(4.1, 4.1, 1, .25))\nhist(pmeans, breaks=30, prob=TRUE, xlim=xl, las=1, xlab=\"treatment effect (ratio in expected survival)\", ylab=\"Density\",\n     main=\"\", cex.axis=.8, xaxt='n')\naxis(1, at=c(.5,1,1.5,2,2.5,3,3.5), cex.axis=.8)\n#axis(2, at=c(1,2,3,4,5,6), cex=.8, las=1)\nlines(hist_est_trt$tgrid, hist_est_trt$dens_grid, lwd=2)\nlines(hist_est_prev$tgrid, hist_est_prev$dens_grid, col=\"red\", lwd=2)\n#lines(sdens_trt$x, sdens_trt$y, lwd=2)\n#lines(sdens_prev$x, sdens_prev$y, lwd=2, col=\"red\")\nabline(v=1, lwd=3, lty=2)\ntext(1.0,4.5,labels=\"Mean log-survival time = 7.08\", cex=.9)\ntext(1.02,4.1,labels=\"Average Treatment Effect = 0.56\", cex=.9)\ntext(1.02,3.7,labels=\"Est. Proportion who benefit = 0.98\", cex=.9)\nlegend(\"topright\", col=c(\"black\",\"red\"), legend=c(\"Treatment Trial\",\"Prevention Trial\"),bty=\"n\", lwd=3)\ndev.off()\n\n\n#1 - hist_est_trt$Postedf(1)   ##  about 95% - %% 95.6%\n#1 - hist_est_prev$Postedf(1)  ##  about 86% - %%  89.1%\n\n\n\n#################################################################################################\n##### male vs. female\n########################################\n\nmale_ind <- new_solvd$gender==1\nfemale_ind <- new_solvd$gender==0\nmale_group <- rowMeans(obj$Theta[,male_ind])\nfemale_group <- rowMeans(obj$Theta[,female_ind])\n\nsummary(male_group)\nsummary(female_group)\n\n\nnreps <- length(male_group)\nff <- sign(male_group)*sign(female_group)\nsum(ff== -1)/nreps\n\nda_male <- density(male_group)\nda_female <- density(female_group)\n\ntxt_lab <- expression(paste(\"P(sign(\", theta[male],\") != sign(\", theta[female],\")|y) = 0.89\"))\n\npostscript(file=\"~/Presentations/ENAR16/Figures/male_female.eps\", width=6.5,\n           height=4.5, horizontal=FALSE)\nplot(da_male$x, da_male$y, main=\"\", las=1, xlab=\"difference in log survival time (days)\", type=\"n\", ylab=\"Density\",\n     ylim=c(0,3.8),xlim=c(-.25,1))\nlines(da_male$x, da_male$y, lwd=2)\nlines(da_female$x, da_female$y, lwd=2, col=\"red\")\nlegend(\"topleft\", col=c(\"black\",\"red\"), legend=c(\"Male\",\"Female\"),bty=\"n\", lwd=3)\ndev.off()\n\n\n\n\n\n\n\nlower.quantile <- apply(obj$Theta, 2, function(x) quantile(x, prob=.025))\nupper.quantile <- apply(obj$Theta, 2, function(x) quantile(x, prob=.975))\npmedian <- apply(obj$Theta, 2, median)\nind <- order(pmedian)\n\nlower.quantile <- lower.quantile[ind]\nupper.quantile <- upper.quantile[ind]\npmedian <- pmedian[ind]\nyax <- seq(1, 2142, length.out=2142)\n\npostscript(file=\"~/Presentations/ENAR16/Figures/individualized.eps\", width=6.5,\n           height=4.5, horizontal=FALSE)\npar(mfrow=c(1,1), mar=c(4, 4, 1, .25))\nplot(0,0, type=\"n\", ylim=c(1,2142), xlim=c(-1.02,2.02), las=1, cex.axis=.8, xlab=\"treatment effect\",\n     ylab=\"Patient index\")\n#axis(1, at=c(-2,0,2,4), cex=.8)\n#axis(2, at=c(500,1000,2000), cex=.8)\nfor(k in 1:2142) {\n  points(pmedian[k],yax[k], col=\"red\", pch=16, cex=.6)\n  lines(c(lower.quantile[k], upper.quantile[k]), c(yax[k], yax[k]),lwd=.8)\n}\nabline(v=0, lwd=3, col=\"grey\")\nlegend(\"topleft\", legend=\"Estimated Trt. Effect\", col=\"red\", pch=16, bty=\"n\", cex=.8)\ndev.off()\n\n\n###################################################################\n###  Regression with Posterior means\n\n\n\npmedian <- apply(obj$Theta, 2, median)\npvar <- apply(obj$Theta, 2, var)\n#pmedian <- apply(A, 2, function(x) mean(x <= 0))\n#pmedian <- exp(pmedian)/(1 + exp(pmedian))\ntmp <- data.frame(pmedian=pmedian,  age=new_solvd$age, lvef=new_solvd$lvef, gender=new_solvd$gender, smoke=new_solvd$smoke,\n                  diabet=new_solvd$diabet, sodium=new_solvd$sodium, avsys=new_solvd$avsys, weightkg=new_solvd$weightkg,\n                  histk=new_solvd$histk, avdia=new_solvd$avdia, creatinine=new_solvd$creatinine, beat=new_solvd$beat,\n                  copd=new_solvd$copd, anydiurbl=new_solvd$anydiurbl, depedema=new_solvd$depedema)\nlmfit <- lm(pmedian ~ ., data=tmp, weights=pvar)\n\n\nsummary(lmfit)\n\n\nabs_tval <- abs(coef(summary(lmfit))[,1]/coef(summary(lmfit))[, 2])\n\nB <- coef(summary(lmfit))\nB <- B[order(-abs_tval),]\n\n\nxtable(B, digits=6)\n\n\n\n\n\n\n\n\n",
    "created" : 1521406286312.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2937958710",
    "id" : "856F1FB5",
    "lastKnownWriteTime" : 1484149708,
    "last_content_update" : 1484149708,
    "path" : "~/personalized/FinPaperGraphs/hist_graphs.R",
    "project_path" : null,
    "properties" : {
        "tempName" : "Untitled23"
    },
    "relative_order" : 29,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}